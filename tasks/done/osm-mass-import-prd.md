# PRD: OpenStreetMap Mass Import Integration

## Overview

Add mass-import functionality for OpenStreetMap public artwork data generated by `src\data-collection\osm\fetch-osm-artworks.js`. This will enable bulk importing of OSM artwork data with proper attribution, tagging, and integration into the existing Cultural Archiver platform.

## Data Source Analysis

**Input Format**: GeoJSON FeatureCollection from `src\data-collection\osm\output\merged\merged-artworks.geojson`

**Sample Data Structure**:
```json
{
  "type": "Feature",
  "id": "node/4343692187",
  "properties": {
    "osm_type": "node",
    "osm_id": 4343692187,
    "artist_name": "Brent Sparrow Jr.",
    "artwork_type": "carving",
    "material": "wood",
    "name": "Musqueam Post",
    "tourism": "artwork",
    "website": "https://example.com"
  },
  "geometry": {
    "type": "Point",
    "coordinates": [-123.2511237, 49.2653777]
  }
}
```

## Implementation Decisions

### 1. Import Processing Strategy
**SELECTED: A** - Use existing sequential mass-import system with batch processing  
Create dedicated OSM importer that follows existing `vancouver.ts` pattern

### 2. Data Validation & Quality  
**SELECTED: B** - Extend the generic `import` command with an `--importer osm` flag  
Allow CLI override of data source path while maintaining sensible defaults

### 3. Duplicate Detection Strategy
**SELECTED: B** - Enhanced detection: 100m radius + fuzzy name matching + external_id check  
Accounts for potential coordinate variations between sources

### 4. Tag Structure Mapping
**SELECTED: B** - Create OSM-specific field mappings that handle OSM tags  
Handle tourism, artwork_type, material, and other OSM-specific properties

### 5. Attribution & Licensing
**SELECTED: D** - Use plugin-style architecture where importers are loaded from configuration  
Create an importer registry system that auto-discovers available importers

### 6. Fallback Behavior for Missing Importer
**SELECTED: Tell user they need to define an importer, but "All" can be used to run all importers**  
Provide clear error message with available options

### 7. User Assignment & Permissions
**SELECTED: Move** `src\config\osm-import-config.json` to `src\lib\mass-import\src\importers\osm-config.json`  
This becomes the settings file for the OSM importer

### 8. Error Handling & Recovery
**SELECTED: B** - Use configurable validation based on the preset (vancouver/strict/permissive)  
Leverage existing flexible validation system

### 9. Progress Tracking & Monitoring
**SELECTED: B** - Enhanced detection: 100m radius + fuzzy name matching + external_id check  
Accounts for potential coordinate variations between data sources

### 10. Configuration & Customization
**SELECTED: C** - Add OSM-specific metrics (missing names, websites found, etc.)  
Provides useful OSM-specific insights for import monitoring

## Technical Specification

### Field Mappings

- `properties.name` â†’ `title`
- `properties.artist_name` â†’ `created_by`
- `geometry.coordinates[0]` â†’ `lon`
- `geometry.coordinates[1]` â†’ `lat`
- `id` â†’ `external_id` tag
- All other properties â†’ individual tags

### Required Tags

- Source: "OpenStreetMap"
- License: "[ODbL](https://www.openstreetmap.org/copyright)"
- Attribution: "Â© OpenStreetMap contributors"
- External ID: OSM feature ID (e.g., "node/4343692187")

### CLI Commands

- `npx tsx src/cli/index.ts import --importer osm <file>` - Import with OSM mapper
- `npx tsx src/cli/index.ts import --importer vancouver <file>` - Import with Vancouver mapper
- `npx tsx src/cli/index.ts import --importer all <file>` - Run all available importers
- Default behavior: Require importer specification with helpful error message

### API Endpoints

- `POST /api/mass-import/osm` - Trigger OSM import from file path
- `GET /api/mass-import/osm/status/{batch_id}` - Check import progress
- `GET /api/mass-import/osm/history` - List previous OSM import batches

## Success Criteria

- Successfully import >95% of valid OSM records
- Proper duplicate detection prevents data duplication
- All imports properly attributed to OpenStreetMap
- Import process completes Vancouver dataset (~2000 records) in <5 minutes
- Comprehensive error logging for failed records
- Integration with existing mass-import infrastructure

## Implementation Plan

1. **Create OSM Importer**: `src/lib/mass-import/src/importers/osm.ts`
2. **Move Configuration**: `src/config/osm-import-config.json` â†’ `src/lib/mass-import/src/importers/osm-config.json`
3. **Enhance CLI**: Add importer registry and selection system
4. **Update Validation**: Integrate configurable validation based on presets
5. **Testing**: Comprehensive test coverage for OSM data mapping

## Implementation Status

âœ… **Configuration File Moved**: OSM config relocated to importers directory  
ðŸ”„ **OSM Importer**: In development - `src/lib/mass-import/src/importers/osm.ts`  
â³ **CLI Enhancement**: Pending - Add importer registry system  
â³ **Validation Integration**: Pending - Connect with existing validation  
â³ **Testing**: Pending - Comprehensive test coverage

## Usage Examples

```bash
# Import OSM data with specific file
npx tsx src/cli/index.ts import --importer osm src/data-collection/osm/output/merged/merged-artworks.geojson

# Dry run validation
npx tsx src/cli/index.ts import --importer osm --dry-run merged-artworks.geojson

# Import with all available importers
npx tsx src/cli/index.ts import --importer all data.json

# Show available importers (error message)
npx tsx src/cli/index.ts import data.json
# Error: Please specify an importer. Available: vancouver, osm. Use 'all' to run all importers.
```

## Notes

Update the existing `mass-import` system (src\lib\mass-import) to support the OSM import by adding a new importers to `src\lib\mass-import\src\importers` for OSM

I should be able to configure the mass-import system to use a specific importer from the command line. `importer vancouver` or `importer osm`, etc... If no importer is defined then it runs all the importers sequentially 

Use this file `scripts\osm-import.js` as a reference for the OSM importer

The default data source for the OSM importer is `src\data-collection\osm\output\merged\merged-artworks.geojson`

See this PRD for more informaiton tasks\osm-mass-import-prd.md